---
title: |
  | Green Taxi: 
  | Competitor Market Analysis
subtitle: "Assessed By `r params$assessor`"
author: |
  | Report Generated By `r params$generator`
  | Written By James Wright
date: |
  | Report Generated On
  | `r format(Sys.Date(), format="%A, %d %B %Y")`
  | 
  | Date First Published 
  | `r format(as.Date("2023-06-09"), format="%A, %d %B %Y")`
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: kable
mainfont: "Arial"
geometry: margin=1in
params:
  generator: 
    label: "Person Generating The Report:"
    value: "User"
  assessor:
    label: "Person Assessing The Report:"
    value: "Barbara Mikulášová"
  dir:
    label: "Path to Root Folder of Project:"
    value: "/Users/jameswright/Desktop/Amadeus/Graduate Programme/Taxi/"
---

```{r, installing-required-packaged, echo = FALSE, warning = FALSE, message = FALSE, include = FALSE,}
## Installs any packages locally to this knitr reporting session if missing, otherwise setdiff is false and does nothing. It should not install them to your packages permanently if it works, it doesn't for me.
## NB/ May not work in Windows - if not go and run Package_Manager.R if it gets upset at you.
# Packages
packages <- c("rmarkdown", 
              "knitr", 
              "ggplot2",
              "dplyr",
              "tibble",
              "stringr",
              "lubridate",
              "readr",
              "tidyr",
              "purrr",
              "openxlsx",
              "scales",
              "roxygen2",
              "knitr",
              "gam")

# Install
for (package in packages){
  if (!require(package,character.only = TRUE))
  {
    install.packages(package,dep=TRUE, quiet=TRUE, repos = "http://cran.us.r-project.org")
    if(!require(package,character.only = TRUE)) {
      stop("Package not found")
    }
  }
}
```


\pagebreak

```{r include=FALSE}
# Set options
knitr::opts_chunk$set( 
  root.dir = getwd(),
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE, 
  include = FALSE,
  fig.align = 'center',
  out.width = "70%",
  out.height = "40%")

# Ban use of scientific notation for entire session
options(scipen=999)

# Source autoexec and data import, and set path
path <- params$dir
programs_path <- file.path(path, 'R', 'Programs')
source(file.path(programs_path, 'autoexec.R'), local = knitr::knit_global())
source(file.path(programs_path, 'data_import.R'), local = knitr::knit_global())
```

# Data Quality Report

```{r}
# Import data processing file
source(file.path(programs_path, 'data_processing.R'), 
       local = knitr::knit_global())
```


## Metadata Quality Issues

Summary of problems and corrections with the metadata on import:

* All variable names should be made upper-case by convention for formatting clarity;
* There should be a consistent variable name word-separation convention across table variables; 
  - For example, variable PAYMENTTYPE in taxi_trips renamed to PAYMENT_TYPE.
* There should be a consistent variable name conventions across all tables; 
  - For example, variable LOCATION_CODEID in taxi_time_location was renamed to LOCATIONID for a consistent ID format across tables and common name across tables.
* Missing variables 
  + Tip amount only includes credit card tips, data should be collected on cash tips to help future analysis.
  + The entire variable LOCATION_DETAILS column in taxi_time_location was missing but is in appendix;
    - Added containing NA values, for completeness, on load.
* Ill-defined groups in appendix - 'no charge', 'dispute', 'voided' need clear definitions of their categorisation for potential prediction of missing value purposes.

## Duplication Issues

Summary of problems and corrections of duplicates:

* There should not be duplicates stored in the data.
- There were `r nrow(taxi_trips_duplicates)` duplicates in the taxi_trips data, `r nrow(taxi_zone_lookup_duplicates)` duplicates in the taxi_zone_lookup data, and `r nrow(taxi_time_location_duplicates)` duplicates in the taxi_time_location data. 
- The duplicates have been saved as an Excel file in the 'Reports' folder to help review which data gets duplicated in the collection process.

\newpage

## Unexpected Data Value Issues

Summary of problems and corrections of the data values:

* Unexpected values;
  + There are negative and positive fare amounts. This might make sense as they could be refunds for voided and free trips so they have been kept in the cleaned data, but for clarity data should be collected or flags assigned to point out where a $\pm$ sign comes from.
  + In rows of taxi_zone_lookup, there is a zone 'NV' which is inconsistent with the naming of other zones. Care should be taken inputting values to be consistent.
    - This was treated as typo for NA based on the surrounding context of other NAs in the row, and made 'Unknown' for reporting purposes.
  + Number of passengers has values up to 30. The typical capacity of a taxi is only going to be 6 people, so data is possibly being collected on the wrong kinds of vehicles or entered wrongly.
* Unexpected categories - all data category values must be accounted for / explained;
  + Payment type '7' and rate code '8' are not defined in the appendix but exist in the data.
    - Redefined '7' values as Unknown '5' in the cleaned data for reporting purposes.
  + Rate code '8' is not defined in the appendix but exists in the data. 
    - Leaving as it is, as all correspond to vendor 3 who might have their own rate code like New York cabs.
* Value distribution
  + There is a disproportionate amount of Other versus Uber data versus Green taxis, this may reflect the proportion of the true market share by each vendor, but this must be checked to make sure the data collection is fair.

```{r include=TRUE}
# Bar plot of passenger_count by vendorid
bar_passenger
```

\newpage

## Missing Data Issues

* Inconsistency with naming convention for missing values - e.g. Unknown, N/A, NA, NV. 
  + All not available data should follow a common naming convention.
* The entire E-Hail fee column is missing. Data must be collected for all stored variables or stop storing the variable.
    - For analysis purposes, the column was dropped as it was not needed.
* Other vendors have entirely missing columns of values for forward flag, rate code, e-hail fee, passenger count, and congestion surcharge. 
  - This data needs to be collected or other data collected that enables you to infer these values using known values.
* Data was only available in 2021 for late June to early August. More data should be collected for more comprehensive analysis of 2021.

### Count of Columns with Missing Values

```{r include=TRUE}
# Display Only Columns with Missing Values and Their Count
knitr::kable(taxi_trips_unduplicated_number_missing %>% 
        select(where(~ any(.>0))),
      col.names = c('Forward Flag', 'Passenger Count', 'E-Hail Fee', 'Congestion Surcharge'),
      digits = 0,
      align='c',
      caption = "Count of Columns with Missing Values")
```

All of the values 32518 come from the other vendor, so data needs to be better collected on that vendor. 

\newpage 

## Extreme Data Issues

```{r include=TRUE}
# Plot distribution of trip_distances by store_and_fwd_flag, defining outliers as beyond 10*IQR as you expect a wider range of taxis
boxplot_store_distance
```  


```{r include=TRUE}
# Plot distribution of trip_distances by trip_type, defining outliers as beyond 10*IQR as you expect a wider range of taxis
boxplot_type_distance
```
* There are distances travelled as large as 270,000 miles - this is likely poorly entered data as most of the extreme values come from the other category, which has an unknown automatic forwarding flag. 
  + Data only really needs to be collected up to around 40 miles as this is the maximum normal distance journey you can expect a New York taxi or its competitotrs to travel, and this is reflected by the scatter density of outliers for the pink taxi and uber categories once filtered to 40 miles.
  + We restrict the data to up to 40 miles in the cleaned data for analysis.
  
```{r include=TRUE}
# Density Plot of trip_distance vs fare_amount
bin2d_distance_fare
```

* There is a single outlier fairs of over \$200 for values of around 0 Miles, while also unexpected fairs of \$50 or lower for distances over 10,000 miles - which is clearly wrong intuitively. There must be mistakes in how the data for fare amounts and distances are collected, or the wrong data is being collected to include non-standard 'taxis'.
  + Most fairs in the 70 mile range are between -\$200 and \$200, with a few outliers above and below, so restricted the data to fares between -\$200 and \$200 for analysis. We retain 0 mile and negative fairs as these may have been disputes or voided trips.

\newpage

# Data Analysis Report

```{r}
# Import data analysis file
source(file.path(programs_path, 'data_analysis.R'), local = knitr::knit_global())
```

***Important Note:*** This analysis is conducted using only July 2021 data, as only data from late June to early August was available. We chose to consider only July 2021 data so as to present the data over a well-defined non-arbitrary time frame. A natural way to extend the estimate to the analogous yearly results would be to multiply the presented July values by 12, however this estimates accuracy would depend on July's similarity to the other 11 months, such as March or December. To do so reliably, it must be the case that 'on average' a year is balanced out^[Aside: For reference, making this is type of estimate is formally called an [ergodic regime.](https://en.wikipedia.org/wiki/Ergodic_process).] so that July is a typical representative of a typical month in a year. We have no intuitive reason to believe July could be representative of the rest of the year on average so cannot make this assumption - in fact, you would expect months such as July and December to be atypically busy in New York due to tourism and extreme weather, that is, external factors will be influencing demand, traffic flow, and so on for the data we have available. Hence, we leave the analysis results for the month of July only.

We conduct the analysis on data from distances of up to 70 miles as this is taken to be the typical competition radius of interest for a New York taxi provider.

## Assumptions

We will take an estimate cost-per-mile for our non-Green taxi data to be that of a typical diesel car, roughly \$0.20 - less than 5% of Ubers are electric, and we will assume the other competitor is also not green. We will also take an estimate cost-per-mile for Green taxis to be that of a typical electric car, roughly $0.03.

Hence, profit per trip is computed as, where $\alpha_{i=1}$ would be \$0.03 for Green taxi, or $\alpha_{i=2}$ and $\alpha_{i=3}$ would be \$0.20 for Uber or other,
\begin{align*}
  \text{Profit} &= \underbrace{\text{Total Amount}}_\text{Revenue-Per-Trip} \\ &- \underbrace{(\alpha_i \text{Miles} + \text{Congestion Surcharge} + \text{Tolls Amount} + \text{MTA Tax} + \text{Improvement Surcharge})}_\text{Cost-Per-Trip}.
\end{align*}


## Average Weekday Expenditure

```{r include=TRUE}
# Table of average amount of money spent by Green taxi across the week
knitr::kable(average_spent_week_green_taxi_2021,
      col.names = c('Weekday', 'Average Spend'),
      digits = 2,
      align = "lc",
      caption = "Average Amount Spent on Taxi Trips with Green Taxi On A Weekday in July 2021")
```

We see the more was typically spent on Sunday on average, with a value of `r average_spent_week_green_taxi_2021[[1,2]]`.

\newpage

## Feature Effect on the Tip Amount for Green Taxi

We only consider non-zero dollar tips to study the influence of features on the tip amount. We also independently study the effect of the features on tip or no tip. As the tip data only includes the payments with credit card, we only consider the credit card payment type.

### No Feature Prediction

Below we present how we would make a prediction of the tip amount without use of any features, as a benchmark of the relative performance of our features.

```{r include=TRUE}
# Display Mean Tip Amount For Green Taxi
knitr::kable(tipamt_stats %>% select(mean_tip),
      col.names = c('Mean Tip Amount ($)'),
      align = "c",
      caption = "Mean Tip Amount in July 2021")
```

Without using a feature we would guess a tip amount of `r dollar(tipamt_stats[[1,1]])` for any given journey. 

```{r include=TRUE}
# Bar chart of tip amount, binned as tip or no tip
notip
```

We see there is around a 62% chance of being given a tip without using a feature to support our guess, which means predicting a tip is only slightly more likely than a coin-toss without using a feature to support the prediction.

\newpage

### Pick-Up Hour

```{r include=TRUE}
# Display Mean Tip Amount For Green Taxi
knitr::kable(tipamt_stats_pickup_hour %>% select(PICKUP_HOUR, mean_tip, count_tip),
      col.names = c('Pick-Up Hour', 'Mean Tip Amount ($)', 'Group Size'),
      align = "ccc",
      caption = "Mean Tip Amount in July 2021 by Pick-Up Hour")
```

We cannot make conclusions on the hours of 1:00 to 6:00 as the sample size is too small.

```{r include=TRUE}
# Bar plot of tip amount by pick-up hour
tipamt_pickup_hour
```

We see from the above bar plot that the early hours of the morning 2:00-6:00 will have higher tips on average than our featureless guess `r dollar(tipamt_stats[[1,1]])`, however the sample sizes is too small for this to be considered more than random variation and so we cannot make a conclusion from this - more data must be collected. Outside of these early hours, the tips across all hours are not too distant from our featureless average.

```{r include=TRUE}
# Bar chart of tip amount, binned as tip or no tip, by pick-up hour
notip_pickup_hour
```

For the hours of midnight to 6:00 we cannot make a conclusion about the predictive power of a tip or no tip, as the sample sizes are far too small in these hours and more data needs to be collected. In the evening, there is an over 70% chance of receiving a tip versus a 62% chance estimate if we did not use this feature. From 7:00 to 17:00 this feature does not give us much more predictive power on whether or not a tip will be given than our featureless guess 62% probability as these values are only between 58% and 70%.

Hence, it follows that during daytime hours, a feature of pick-up hour would be a poor predictor of tip amount in general as it is neither good at predicting whether a tip will be given or not, and does not predict a value much different from a featureless average tip anyway. From 17:00 to 23:00 this feature is good for predicting whether or not a tip itself will occur, however the tip amount predicted is no better than a average estimate without the feature. In the early hours of the morning we don't have large enough sample data to make a conclusion. 

In summary, this feature is not a useful predictor of tip amount - as during the daytime hours it is poor at predicting whether or not a tip will happen or improve the estimate beyond the overall tip average itself. Outside of daytime hours, it will predict whether or not a tip will occur but not give an estimate better than the overall average.

### Payment Type

It is impossible to know if payment type has any impact on the tip amount given that the tip amount data only tracks tips made on credit card. More data must be collected on cash tips.

\newpage

### Passenger Count

```{r include=TRUE}
# Display Mean Tip Amount For Green Taxi
knitr::kable(tipamt_stats_passenger_count %>% select(PASSENGER_COUNT, mean_tip, count_tip),
      col.names = c('Passenger Count', 'Mean Tip Amount ($)', 'Group Size'),
      align = "ccc",
      caption = "Mean Tip Amount in July 2021 by Passenger Count")
```

We cannot make conclusions for 0 and 5 passengers as the sample size is too small.

```{r include=TRUE}
# Bar plot of tip amount by passenger_count
tipamt_passenger_count
```

The bar plot above shows that the average tip by passenger count is noticeably different than for our featureless mean for 3 and 4, making it a useful predictor of the tip amount given. On the other hand, for 1 and 2 passengers it predicts similarly to the featureless mean. As a majority of trips are 1 or 2 passengers, this makes it a poor predictor of tip amount for the typical trip. While 0 and 5 passengers vary significantly from the featureless mean, the sample size for these is too small to conclude anything other than random variation.

```{r include=TRUE}
# Bar chart of tip amount, binned as tip or no tip, by passenger_count
notip_passenger_count
```

The above graph indicates that 2 to 4 passengers are almost surely going to give any kind of tip with a probability of around 90%. For 1 passengers, the probability of receiving a tip is between 60% and 70% which is not much different from our featureless estimate of 62%. For 0 passengers (say, delivery) and 5 passengers we don't have enough data to draw a conclusion.

Overall, passenger count is a useless predictor of tip amount for single passenger journeys, as it provides almost the same information as a featureless estimate. For 2-4 passenger journeys it is a useful feature as it tells you to expect a tip, and although for 2 passengers it provides the same estimate - for 3 and 4 passengers provides a better estimate than a featureless estimate. Hence, it is a good feature to predict tip amount taken as a whole.

### Pick-Up Borough 

```{r include=TRUE}
# Display Mean Tip Amount For Green Taxi
knitr::kable(tipamt_stats_pickup_borough %>% select(PICKUP_BOROUGH, mean_tip, count_tip),
      col.names = c('Pick-Up Borough', 'Mean Tip Amount ($)', 'Group Size'),
      align = "lcc",
      caption = "Mean Tip Amount in July 2021 by Pick-Up Borough")
```
We cannot make conclusions for unknown borough as the sample size is too small, however as we do not know the borough this would not help anyway.

```{r include=TRUE}
# Bar chart of tip amount by pick-up borough
tipamt_pickup_borough
```

We see that the average tip does not vary significantly by pick-up borough from the featureless tip amount estimate `r dollar(tipamt_stats[[1,1]])`, with the exception of the Bronx which estimates `r dollar(tipamt_stats_pickup_borough[[1,2]])`.

```{r include=TRUE}
# Bar chart of tip amount, binned as tip or no tip, by pick-up borough
notip_pickup_borough
```


Moreover, we see that the probability of the pick-up borough Bronx leading to a tip is less than 10%, so this different in estimate discussed above is irrelevant, but this is useful to determine that a \$0 will likely be given. We see aside from Manhattan and the Bronx, this feature provides no more information in predicting whether or not a tip will occur than a coin toss. In Manhattan, it tells you there is an 80% chance a tip will occur, even though we know from above this tip amount, `r dollar(tipamt_stats_pickup_borough[[1,2]])` will be in the region of our featureless estimate `r dollar(tipamt_stats[[1,2]])`.

Overall, Borough is only useful for providing tip amount information on if a tip will occur in Manhattan and the Bronx boroughs.

\newpage

### Trip distance

We include only non-zero trip distances to avoid cancellation charges and so on, and restrict the visualisation to 40 miles as this is where a majority of the data plotted lies.

```{r include=TRUE}
# Boxplot of tip amount by trip_distance
tipamt_trip_distance
```

For less than 10 miles, we see that trip distance appears to follow a linearly increasing relationship with tip amount, a 1 mile increase in trip distance corresponding to around a \$0.75 increase in tip. As distances increase beyond 10 miles, our tip amounts are increasingly distant from the line of best fit, making it a poor tip amount predictor here.

```{r include=TRUE}
# Bar chart of tip amount, binned as tip or no tip, by trip_distance
notip_trip_distance
```

We see that for 0-10 mile trips there is a roughly 62% chance of a tip being given, the same as guessing based on no features, which makes sense as this is where most of our data lies so should reflect the overall probability. We see from 10+ miles there is a 90%+ probability of being given a tip, however as stated above, the amount predicted will likely be wrong for these values. Given the discussion, trip distance is a good predictor for a majority of trips (up to 10 miles) if paired with another feature that more accurately predicts whether or not a tip will occur.

## Accumulated Profits in 2021


```{r include=TRUE}
# Table of total profit amount by vendorid and format
knitr::kable(accumulated_profit_2021, 
      format.args=list(big.mark=","),
      col.names = c('Company', 'Total Profit'),
      digits = 2,
      align = "lc",
      caption = "Total Profits Per Company in July 2021")
```

We see that the other vendor has accumulated the most profit, with a value of `r format(accumulated_profit_2021[[3,2]], big.mark=",")`, followed closely by Uber with `r format(accumulated_profit_2021[[2,2]], big.mark=",")`. Green taxi had significantly less profit with `r format(accumulated_profit_2021[[1,2]], big.mark=",")` for July 2021.

##  Total Number of Rides

```{r include=TRUE}
# Table of total number of rides
knitr::kable(GT_U_O_total_rides_2021, 
      format.args=list(big.mark=","),
      col.names = c('Company', 'Number of Rides'),
      digits = 0, 
      align = "lc",
      caption = "Total Number of Rides Per Company in July 2021 (Non-Voided Trips)")
```

Uber and the other vendor have significantly more non-voided rides with values of `r format(GT_U_O_total_rides_2021[[2,2]], big.mark=",")` and `r format(GT_U_O_total_rides_2021[[3,2]], big.mark=",")` respectively in July 2021, than Green Taxi which has `r format(GT_U_O_total_rides_2021[[1,2]], big.mark=",")`.

\newpage

## Profit Change Over 2021

```{r include=TRUE}
# Plot of Time series plot of profit change over 2021 for Green taxi and Uber
GT_U_profit_2021
```

We see that the profit amount for Uber is more variable than Green Taxi, but both Green taxi and Uber both have cyclical daily profits that are seemingly correlated with one another - both Green Taxi and Uber see their profits rise and fall simultaneously with what is likely overall taxi demand in New York City. We also see that Green taxi has significantly lower daily profits than Uber, which makes sense as it makes less trips.

## Trip Type Revenues

```{r include=TRUE}
# Bar chart of total revenue for Green taxi by trip type
GT_revenue_2021
```

We see that inner city trips brought significantly more revenue to Green Taxi than outer city ones, and make up a majority of the revenue.

\newpage

## Most Popular Pick-Up Borough

```{r include=TRUE}
# Bar chart of pick up frequency count in each borough by vendor
borough_pickup_2021_total
```

Manhattan is the most popular pick-up borough for both Green Taxi and Uber, while Brooklyn is the most popular pick-up borough for the other competitor.

```{r include=TRUE}
# Bar chart of proportion of pick-ups in each borough by vendor
borough_pickup_2021_proportion
```

In the Bronx and Queens, Green Taxi has a much smaller market share than its competitors, with the other competitor taking most of the market share in the Bronx. Green taxi also does not compete on Staten Island where Uber takes most of the market share.

\newpage

## Peak Hours

```{r include=TRUE}
# Frequency Polygon of taxi service hours by vendor
service_hours_2021
```

Green taxi has its peak hours ranging between , while the other competitor has its peak hours around 10:00, and Uber has its peak hours from 15:00 to 19:00.

```{r include=TRUE}
# Bar chart to find most active in evening
active_evening_2021
```

Green Taxi is equally active throughout the day, while Uber is most active in the evening hours and the other competitor is most active in the morning hours.

\newpage

## Disputed Trips

```{r include=TRUE}
# Bar chart for proportion of disputed trips out of total number of trips by vendor - recoding non-disputes as no dispute for comparison
disputed_proportion
```

Green Taxi has the most disputed trips in a 70 mile radius of New York City, however it is still a tiny proportion of the total trips at less than 1%.